<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel=manifest href=./manifest.json>
<title>Geo Test</title>

<style>
html, body {
    height: 100%;
    margin:0;
    background-color: black;
}
</style>

<script>
var ctx = null;
var w = 0;
var h = 0;
var gps = {coords: {altitude: 0,speed: 0}};
var compass = {alpha: 0};

keep_awake = async function() {
    if(!navigator.wakeLock)
        return;
    try {await navigator.wakeLock.request('screen');} catch (err) {console.log(err);}
}

draw_portrait = function() {
    var center = w / 2;
    var quarter = center / 2;
    ctx.font = quarter / 2 + 'pt Calibri';
    ctx.fillText(Math.round(gps.coords.altitude), quarter, quarter / 2); 
    ctx.fillText(Math.round(3.6 * gps.coords.speed), center + quarter, quarter / 2); 
    draw_compass(center + quarter / 2, cs.height / 2 + cs.height / 4, cs.height / 4, 0);
}

draw_landscape = function() {
    var center = h / 2;
    var quarter = center / 2;
    ctx.font = quarter / 2 + 'pt Calibri';
    ctx.fillText(Math.round(gps.coords.altitude), quarter, quarter / 2); 
    ctx.fillText(Math.round(3.6 * gps.coords.speed), quarter, quarter + quarter / 2); 
    draw_compass(cs.width / 2 + cs.width / 4, center + quarter / 2, cs.width / 4, 0);
}

draw_compass = function(x, y, r, alpha) {
    ctx.lineWidth = 3;
    ctx.strokeStyle = 'green';
//    ctx.shadowColor = 'white';
//    ctx.shadowBlur = 10;
//    ctx.lineJoin = 'bevel';
//   ctx.beginPath();
//   ctx.arc(x, y, r, 0, 2 * Math.PI);
//   ctx.stroke();
    ctx.save();
    ctx.translate(x, y);
//    ctx.rotate(Math.PI / 4 + compass.alpha / 180 * Math.PI);
    ctx.font = r / 7 + 'pt Calibri';
    ctx.fillText(Math.round(compass.alpha), 0, 0);

    ctx.rotate(Math.PI / 2 + compass.alpha / 180 * Math.PI);
    ctx.strokeRect(-r/2, -r/2, r, r);

    ctx.lineWidth = 1;
    ctx.rotate(Math.PI / 4);
    ctx.fillStyle = 'red';
    ctx.fillText("N", 0, -r/2);
    ctx.rotate(Math.PI / 2);
    ctx.fillStyle = 'yellow';
    ctx.fillText("E", 0, -r/2);
    ctx.rotate(Math.PI / 2);
    ctx.fillStyle = 'blue';
    ctx.fillText("S", 0, -r/2);
    ctx.rotate(Math.PI / 2);
    ctx.fillStyle = 'yellow';
    ctx.fillText("W", 0, -r/2);
    ctx.restore();
}

draw = function() {
    w = cs.width;
    h = cs.height;
    ctx.fillStyle = "#00FFFFFF";
    ctx.textBaseline = 'middle';
    ctx.textAlign = 'center';
    ctx.clearRect(0, 0, w, h);
    if(w > h)
        return draw_landscape(ctx, w, h);
    draw_portrait(ctx, w, h);
}

window.onload = function() {
    keep_awake();
    ctx = cs.getContext("2d");
    window.onresize();

    if(navigator.geolocation)
        navigator.geolocation.watchPosition(function(gg) {gps = gg;draw();},function(error) {},{ enableHighAccuracy: true });
}

window.onresize = function() {
    cs.width = window.innerWidth;
    cs.height = window.innerHeight;
    draw();
}

window.addEventListener("deviceorientation", function(e) {
    compass = e;
    draw();
});

document.onvisibilitychange = function() {
    if("visible" === document.visibilityState)
        keep_awake();
}
</script>
</head>
<body>
<canvas id='cs'></canvas>
</body>
</html>

