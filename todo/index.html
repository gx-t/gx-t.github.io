<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>Անելիքներ</title>
<script>

    var uni_input = document.createElement('input');
    var uni_item  = null;

    function save_items() {
        var arr = document.getElementsByTagName("li");
        var todo_data = [];
        todo_data.length = arr.length;
        todo_data.fill();
        for(var i = 0; i < arr.length; i ++) {
            var o = {t: arr[i].innerText, s: arr[i].state};
            todo_data[i] = o;
        }
        localStorage.todo_data = JSON.stringify(todo_data);
    }

    function load_items() {
        if(!localStorage || !localStorage.todo_data)
            return;

        var arr = JSON.parse(localStorage.todo_data);
        arr.forEach(function(el) { var item = add_item(el.t, el.s); });
    }

    uni_input.onblur = function() {
        if(0 < uni_input.value.length) {
            uni_item.innerText = uni_input.value;
        }
        uni_input.replaceWith(uni_item);
        setTimeout(function() { update_state(uni_item); uni_item = null; }, 500);
        return false;
    }

    uni_input.onkeydown = function(evt) {
        if(evt.keyCode != 13)
            return;
        uni_input.blur();
    }

    var state_proc_arr = [
        function() {
            this.oncontextmenu = edit_item;
            this.innerHTML = this.innerText.normalize();
        },

        function() {
            this.oncontextmenu = edit_item;
            this.innerHTML = this.innerText.bold();
        },

        function set_inprogress() {
            this.oncontextmenu = edit_item;
            this.innerHTML = this.innerText.italics();
        },

        function() {
            this.oncontextmenu = delete_item;
            this.innerHTML = this.innerText.strike();
        }
    ];

    function update_state(item) {
        item.state %= state_proc_arr.length;
        state_proc_arr[item.state].call(item);
        save_items();
    }

    function edit_item() {
        if(uni_item)
            return;

        uni_item = this;
        uni_input.value = this.innerText;
        this.replaceWith(uni_input);
        uni_input.focus();

        return false;
    }

    function delete_item() {
        if(confirm("Հաստատեք որ ուզում եք ջնջել՝\n\n" + this.innerText)) {
            this.remove();
        }
        save_items();
        return false;
    }

    function onclick() {
        if(uni_item)
            return;

        this.state ++;
        update_state(this);
    }

    var add_item = function(text, state) {
        var item = document.createElement("li");
        item.innerText      = text;
        item.style          = "cursor:default";
        item.onselectstart  = function() { return false; };
        item.onclick        = onclick;
        item.state          = state;
        sp.appendChild(item);
        update_state(item);
    }

    window.onload = function() {
        load_items();
    }
</script>
</head>
<body>
<h3>Անելիքներ</h3>
    <div id="sp">
    </div>
    <hr>
    <a href='javascript:add_item("<Նոր անելիք>", 0);'><img src=img/new-item.svg width=32 height=32></a>
</body>
</html>
